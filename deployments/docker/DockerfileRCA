# Build stage
FROM golang:1.22-alpine AS builder

WORKDIR /build

# Copy go mod files
COPY go.mod go.sum ./
RUN go mod download

# Copy source code
COPY . .

# Build RCA service (no CGO needed for RCA)
RUN CGO_ENABLED=0 go build -o rca-service ./cmd/rca/main.go

# Runtime stage
FROM alpine:latest

RUN apk --no-cache add ca-certificates

WORKDIR /app

# Copy binary
COPY --from=builder /build/rca-service .

# Copy default config
COPY configs/rca_dev.yaml ./rca_dev.yaml

# Create non-root user
RUN addgroup -g 1000 -S rca && \
    adduser -u 1000 -S rca -G rca && \
    chown -R rca:rca /app

USER rca

ENTRYPOINT ["./rca-service"]
